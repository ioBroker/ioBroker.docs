{"version":3,"file":"web.js","sourceRoot":"","sources":["../../src/lib/web.ts"],"names":[],"mappings":"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","sourcesContent":["'use strict';\n\nimport fs from 'node:fs';\nimport path from 'node:path';\nimport httpModule from 'node:http';\nimport httpsModule from 'node:https';\nimport express, { Express, Request, Response, NextFunction } from 'express';\nimport bodyParser from 'body-parser';\nimport cors from 'cors';\nimport ExpressBruteConstructor from 'express-brute';\n\nimport Logger from './logger';\nimport { AppConfig } from '../types';\n\n// HTTP(S) Modul je nach `secure`\n\nconst logger = new Logger();\n\nconst ExpressBrute: any = (ExpressBruteConstructor as any).default || (ExpressBruteConstructor as any);\n\n// Bruteforce\\-Schutz\nconst bruteforce = new ExpressBrute(new ExpressBrute.MemoryStore(), {\n    freeRetries: 5,\n});\n\n// App\\-Container\ntype ServerLike = httpModule.Server | httpsModule.Server;\n\nconst app: {\n    app: Express;\n    server: ServerLike | null;\n} = {\n    app: express(),\n    server: null,\n};\n\n// Zusätzliche Typen für Konfiguration und Redirects\ntype SiteConfig = AppConfig['sites'][number];\n\ntype RedirectsMap = Record<string, string>;\n\n// \\`req.brute\\` kommt von express\\-brute, daher \\`any\\`\ninterface BruteRequest extends Request {\n    brute: {\n        reset: (cb: (() => void) | undefined) => void;\n    };\n}\n\n// Port normalisieren\nfunction normalizePort(val: string | number): number | string | false {\n    const port = parseInt(String(val), 10);\n\n    if (isNaN(port)) {\n        return val;\n    }\n\n    if (port >= 0) {\n        return port;\n    }\n\n    return false;\n}\n\nexport default function init(config: AppConfig): {\n    app: Express;\n    server: ServerLike | null;\n} {\n    const port = normalizePort(process.env.PORT || config.port || 443);\n\n    let httpsOptions: httpsModule.ServerOptions | Record<string, never>;\n    if (!config.secure) {\n        httpsOptions = {};\n    } else {\n        httpsOptions = {\n            key: fs.readFileSync(config.certs.key || `${__dirname}/certs/cert.key`),\n            cert: fs.readFileSync(config.certs.cert || `${__dirname}/certs/cert.crt`),\n            ca: fs.readFileSync(config.certs.chain || `${__dirname}/certs/chain.crt`),\n        };\n    }\n\n    app.app.disable('x-powered-by');\n\n    // X\\-Frame\\-Options\n    app.app.use((req: Request, res: Response, next: NextFunction) => {\n        res.set('X-Frame-Options', 'SAMEORIGIN');\n        next();\n    });\n\n    if (config.sites) {\n        config.sites.forEach((site: SiteConfig) => {\n            console.log(`Install path ${site.route} => ${site.path}`);\n            let redirects: RedirectsMap | undefined;\n            if (site.redirects && fs.existsSync(site.redirects)) {\n                try {\n                    redirects = require(site.redirects) as RedirectsMap;\n                } catch (e) {\n                    console.error(`Cannot read ${site.redirects}: ${e}`);\n                }\n            }\n            app.app.use(site.route, (req: Request, res: Response, next: NextFunction) => {\n                if (req.url.endsWith('.html')) {\n                    req.url = req.url.replace(/\\.html$/, '.htm');\n                } else if (req.url.endsWith('/')) {\n                    req.url += 'index.htm';\n                }\n\n                if (redirects) {\n                    const name = req.url.split('?')[0].replace(/^\\//, '');\n                    if (redirects[name]) {\n                        return res.redirect(redirects[name]);\n                    }\n                }\n\n                if (req.url.startsWith('/.git')) {\n                    res.status(404).send('not found');\n                } else {\n                    express.static(site.path)(req, res, next);\n                }\n            });\n        });\n    }\n\n    // CORS für adapterref\n    app.app.options('/*/adapterref/*', cors());\n    app.app.use('/*/adapterref/*', cors());\n\n    // Statisches Verzeichnis\n    console.log(`Serving ${path.join(__dirname, '../..', config.public)}`);\n    app.app.use(express.static(path.join(__dirname, '../..', config.public)));\n\n    app.app.use(bodyParser.json({ limit: 50000000, type: 'application/json' }));\n\n    // Redirect install scripts\n    app.app.get('/fix.sh', (req: Request, res: Response) => res.redirect(301, 'https://iobroker.net/fix.sh'));\n    app.app.get('/install.sh', (req: Request, res: Response) => res.redirect(301, 'https://iobroker.net/install.sh'));\n    app.app.get('/diag.sh', (req: Request, res: Response) => res.redirect(301, 'https://iobroker.net/diag.sh'));\n\n    // Upload\\-Endpoint\n    // @ts-expect-error\n    app.app.post('/', bruteforce.prevent, (req: BruteRequest, res: Response): void => {\n        const file = (req.query as any).file as string | undefined;\n        const secret = (req.query as any).secret as string | undefined;\n\n        if (!file) {\n            res.status(501).json({ error: 'no file name found' });\n            return;\n        }\n        if (secret !== config.secret) {\n            console.error(`invalid secret ${secret}`);\n            res.status(401).json({ error: 'invalid secret' });\n            return;\n        }\n\n        req.brute.reset(() => {\n            const dataDir = path.join(config.public, 'data');\n            if (!fs.existsSync(dataDir)) {\n                fs.mkdirSync(dataDir);\n            }\n\n            const safeName = file.replace(/[^.\\w]/g, '_');\n            const target = path.join(dataDir, safeName);\n\n            console.log(`upload ${target}`);\n            if ((req.body as any).html) {\n                fs.writeFileSync(target, (req.body as any).html);\n            } else {\n                fs.writeFileSync(target, typeof req.body === 'object' ? JSON.stringify(req.body) : (req.body as any));\n            }\n            res.json({ result: 'ok' });\n        });\n    });\n\n    if (!config.secure) {\n        app.app.use((req: Request, res: Response, next: NextFunction) => {\n            res.header('Access-Control-Allow-Origin', '*');\n            res.header('Access-Control-Allow-Methods', 'GET');\n            res.header('Access-Control-Allow-Headers', 'Content-Type');\n\n            next();\n        });\n    }\n\n    // HTTP(S)\\-Server erstellen\n    if (!config.secure) {\n        app.server = httpModule.createServer(app.app);\n    } else {\n        app.server = httpsModule.createServer(httpsOptions, app.app);\n    }\n\n    // Non\\-null Assertion, da nach oben immer gesetzt\n    app.server!.listen(port, config.bind as any);\n\n    app.server!.on('error', error => {\n        if ((error as any).syscall !== 'listen') {\n            throw error;\n        }\n\n        const bind = typeof port === 'string' ? `Pipe ${port}` : `Port ${String(port)}`;\n\n        switch ((error as any).code) {\n            case 'EACCES':\n                logger.error(`${bind} requires elevated privileges`);\n                process.exit(1);\n                break;\n            case 'EADDRINUSE':\n                logger.error(`${bind} is already in use`);\n                process.exit(1);\n                break;\n            default:\n                throw error;\n        }\n    });\n    app.server!.on('listening', () => {\n        const addr = app.server!.address();\n        const bind =\n            typeof addr === 'string' ? `pipe ${addr}` : `port ${addr && 'port' in addr ? addr.port : 'unknown'}`;\n\n        logger.log(`WEB Side started on ${bind}`);\n    });\n\n    return app;\n}\n"]}