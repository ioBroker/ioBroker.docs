{"version":3,"file":"search.js","sourceRoot":"","sources":["../../src/lib/search.ts"],"names":[],"mappings":"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","sourcesContent":["// typescript\n// @ts-ignore\nimport MiniSearchModule from 'minisearch';\nimport path from 'node:path';\nimport fs from 'node:fs';\nimport { getTitle, extractLicenseAndChangelog, extractHeader } from './utils';\nimport type { AppConfig } from '../types';\n\ntype Doc = {\n    id: string;\n    title: string;\n    text: string;\n};\n\ntype TitleEntry = { title: string };\ntype TitlesMap = Record<string, Record<string, TitleEntry>>;\n\n// MiniSearch hat je nach Build keine klare Konstruktor-Signatur, daher `any`\ntype MiniSearchInstance = any;\ntype LangsMap = Record<string, MiniSearchInstance>;\n\nlet langs: LangsMap = {};\nlet titles: TitlesMap = {};\n\n// Einige Bundles exportieren MiniSearch als Default, andere als Named Export.\n// `as any` stellt sicher, dass der Konstruktor verwendbar ist.\nconst MiniSearch: any = (MiniSearchModule as any).default || (MiniSearchModule as any);\n\nfunction loadDocuments(lang: string, dir: string, root?: string, docs?: Doc[]): Doc[] {\n    if (dir.endsWith('/') || dir.endsWith('\\\\')) {\n        dir = dir.substring(0, dir.length - 1);\n    }\n\n    docs ||= [];\n    root ||= dir.replace(/\\\\/g, '/');\n\n    fs.readdirSync(dir).forEach((file: string) => {\n        const name = path.join(dir, file);\n        const stat = fs.statSync(name);\n        if (stat.isDirectory()) {\n            loadDocuments(lang, name, root, docs);\n        } else if (file.match(/\\.md$/)) {\n            const text = fs.readFileSync(name).toString('utf-8');\n            const headerAndBody = extractHeader(text);\n            if (!headerAndBody) {\n                return;\n            }\n            const result = extractLicenseAndChangelog(headerAndBody.body);\n\n            const id = name.replace(/\\\\/g, '/').replace(root + '/', '');\n            const title: string = headerAndBody.header?.title || getTitle(result.body);\n            if (title.indexOf('object') !== -1) {\n                console.log(`Strange title of ${name}: ${JSON.stringify(title)}`);\n            }\n            titles[lang] ||= {};\n            titles[lang][id] = { title };\n            docs.push({ id, title, text: result.body });\n        }\n    });\n\n    return docs;\n}\n\nexport interface ExpressLikeRequest {\n    query?: {\n        ln?: string;\n        q?: string;\n        [key: string]: any;\n    };\n    [key: string]: any;\n}\n\nexport interface ExpressLikeResponse {\n    json: (body: any) => void;\n    [key: string]: any;\n}\n\nexport interface ExpressLikeApp {\n    get: (path: string, handler: (req: ExpressLikeRequest, res: ExpressLikeResponse) => void) => void;\n}\n\nexport function init(app: ExpressLikeApp, config: AppConfig): void {\n    langs = {};\n    titles = {};\n\n    config.LANGUAGES.forEach((lang: string) => {\n        const documents = loadDocuments(lang, path.join(__dirname, '../../', config.public, lang));\n        const miniSearch: MiniSearchInstance = new MiniSearch({\n            fields: ['title', 'text'],\n            searchOptions: {\n                boost: { title: 2 },\n                // fuzzy: 0.2\n            },\n        });\n        miniSearch.addAll(documents);\n        langs[lang] = miniSearch;\n    });\n\n    app.get('/search', (req, res) => {\n        const lang = req.query?.ln || 'de';\n        const q = req.query?.q || '';\n        res.json(search(lang, q));\n    });\n}\n\n// Ergebnistyp fÃ¼r `search`\nexport type SearchResult = {\n    id: string | number;\n    title?: any;\n    [key: string]: any;\n};\n\nexport function search(lang: string, text: string): SearchResult[] {\n    if (!langs[lang]) {\n        return [{ id: 0, text: 'language unknown' }];\n    }\n\n    const mini: MiniSearchInstance = langs[lang];\n    const rawResults: any[] = mini.search(text) || [];\n\n    const r: SearchResult[] = rawResults.map((s: any) => {\n        const titleInfo = (titles[lang] && titles[lang][s.id as string]) || ({} as TitleEntry);\n        // im Original: `s.title = Object.assign({}, s, titles[lang][s.id])`\n        s.title = Object.assign({}, s, titleInfo);\n        return s;\n    });\n\n    if (r.length > 12) {\n        const l = r.length;\n        r.splice(12, r.length - 1);\n        r.push({ id: '...', title: l - 12 });\n    }\n\n    return r;\n}\n// A collection of documents for our examples\n// const documents = [\n//     { id: 1, title: 'Moby Dick', text: 'Call me Ishmael. Some years ago...' },\n//     { id: 2, title: 'Zen and the Art of Motorcycle Maintenance', text: 'I can see by my watch...' },\n//     { id: 3, title: 'Neuromancer', text: 'The sky above the port was...' },\n//     { id: 4, title: 'Zen and the Art of Archery', text: 'At first sight it must seem...' },\n//     // ...and more\n// ]\n"]}